<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Compra de Boletos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css" />
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<h1>Compra de Boletos</h1>
<form id="ticketForm" action="/buyTicket" method="post">

    <!-- paso 1 destino -->
    <label for="fromLocation">De:</label>
    <select id="fromLocation" name="fromLocation" required>
        <option value="" disabled selected>Seleccione un lugar de origen</option>
        <th:block th:each="destination : ${listDestinations}">
            <option th:value="${destination.name}" th:text="${destination.name}"></option>
        </th:block>
    </select><br><br>

    <label for="toLocation">A:</label>
    <select id="toLocation" name="toLocation" required>
        <option value="" disabled selected>Seleccione un lugar de destino</option>
        <th:block th:each="destination : ${listDestinations}">
            <option th:value="${destination.name}" th:text="${destination.name}"></option>
        </th:block>
    </select><br><br>

    <!-- paso 2 fecha -->
    <label for="travelDate">Fecha:</label>
    <input type="date" id="travelDate" name="travelDate" required><br><br>

    <label for="travelTime">Selecione la hora</label>
    <div id="travelTime" name="travelTime"> 
        <input type="radio" id="5AM" name="travelTime" value="05:00">
        <label for="5AM">5AM</label><br>
        <input type="radio" id="12PM" name="travelTime" value="12:00">
        <label for="12PM">12PM</label><br>
        <input type="radio" id="4PM" name="travelTime" value="16:00">
        <label for="4PM">4PM</label><br>
    </div>
        <!-- paso 4 asientos -->
    <label for="seatNumber">Asiento:</label>
    <div id="seatSelection">
        <th:block th:each="seat : ${seatList}">
            <i class="ti ti-armchair seat" th:classappend="${purchasedSeats.contains(seat) ? 'purchased' : ''}" th:data-seat="${seat}"></i>
        </th:block>
    </div>
    <input type="hidden" id="seatNumber" name="seatNumber" required><br><br>

    <!-- paso 5 -->
    <label for="passengerName">Nombre del Pasajero:</label>
    <input type="text" id="passengerName" name="passengerName" required><br><br>
    
    <label for="dni">Ingrese su DNI</label>
    <input pattern="\d{8}" maxlength="8" type="text" id="dni" name="dni" required><br><br>

    <button type="submit">Comprar Boleto</button>
</form>

<script>
    document.querySelectorAll('.seat').forEach(seat => {
        seat.addEventListener('click', function() {
            document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
            this.classList.add('selected');
            document.getElementById('seatNumber').value = this.getAttribute('data-seat');
        });
    });

    document.getElementById('fromLocation').addEventListener('change', updateSeats);
    document.getElementById('toLocation').addEventListener('change', updateSeats);
    document.getElementById('travelDate').addEventListener('change', updateSeats);
    document.querySelectorAll('input[name="travelTime"]').forEach(radio => {
        radio.addEventListener('change', updateSeats);
    });

    function updateSeats() {
        const fromLocation = document.getElementById('fromLocation').value;
        const toLocation = document.getElementById('toLocation').value;
        const travelDate = document.getElementById('travelDate').value;
        const travelTime = document.querySelector('input[name="travelTime"]:checked')?.value;

        if (fromLocation && toLocation && travelDate && travelTime) {
            fetch(`/?fromLocation=${fromLocation}&toLocation=${toLocation}&travelDate=${travelDate}&travelTime=${travelTime}`)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newSeatSelection = doc.getElementById('seatSelection');
                    document.getElementById('seatSelection').innerHTML = newSeatSelection.innerHTML;
                    document.querySelectorAll('.seat').forEach(seat => {
                        seat.addEventListener('click', function() {
                            document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
                            this.classList.add('selected');
                            document.getElementById('seatNumber').value = this.getAttribute('data-seat');
                        });
                    });
                });
        }
    }
</script>
</body>
</html>